import CodeBlock from "@theme/CodeBlock";
import LivekitPoc from "./assets/livekit-poc.html?raw";

# WebRTC over LiveKit

A client may want to use Flow in unsure network conditions or through mobile devices with fluctuating networks. In such scenarios, we offer WebRTC protocol as a way to connect to Flow. More information about the protocol can be found on official [webrtc website](https://webrtc.org/).
Flow uses the WebRTC setup provided by LiveKit to enable support for the protocol.

## API

Client makes a HTTP POST request to `/v1/flow/livekit` endpoint, with body containing StartConversation message as described in the [Flow API reference](/). "audio_format" field must not be used in this scenario as LiveKit WebRTC takes control of the audio format.

```json
{
    "message": "StartConversation",
    "conversation_config": {
      "template_id": "flow-service-assistant-one",
      "template_variables": {
        "timezone": "Europe/London"
      }
    }
  }
}
```

## Response

In response, a LiveKit room is created. The returned URL & token are used to connect to the LiveKit server.

```json
{
  "url": "wss://test-app-d3kro1gz.livekit.cloud",
  "token": "<valid JWT token>",
  "id": "<a request id>"
}
```

## Connecting to LiveKit

Provided JWT token has short TTL and should be used immediately after receiving it.

The LiveKit SDK for a given platform should be used to connect to the LiveKit server. The SDK handles the connection and audio streaming, including bitrate management.
Text messages, or control messages are exchanged using LocalParticipant object.
Protocol for messages with the Flow Agent is the same as in case of normal WebSocket connection to Flow API.

LiveKit documentation can be found [here](https://docs.livekit.io/home/client/connect/)

## Example client in JavaScript

<CodeBlock language="html" title="index.html" showLineNumbers>
  {LivekitPoc}
</CodeBlock>